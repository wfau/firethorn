$def with (text, query, tap_endpoint, filepath, results, survey_prefix)

<!DOCTYPE html PUBLIC"-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html>

<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />

<title>Web2.0 Table Plotter</title>
<link rel="stylesheet" type="text/css"
	href="$survey_prefix/static/static_vo_tool/style_vo_tool.css" />
<link rel="stylesheet" type="text/css"
	href="$survey_prefix/static/static_vo_tool/css/jquery.lightbox-0.5.css"
	media="screen" />
<link rel="stylesheet" type="text/css"
	href="$survey_prefix/static/static_vo_tool/css/jquery-ui-1.8.16.custom.css" />
<link rel="stylesheet" type="text/css"
	href="$survey_prefix/static/static_vo_tool/css/ColReorder.css" />
<link rel="stylesheet" type="text/css"
	href="$survey_prefix/static/static_vo_tool/css/ColVis.css" />
<link rel="stylesheet" type="text/css"
	href="$survey_prefix/static/static_vo_tool/css/demo_table_jui.css" />
<link rel="stylesheet" type="text/css"
	href="$survey_prefix/static/static_vo_tool/css/TableTools.css" />
<link rel="stylesheet" type="text/css"
	href="$survey_prefix/static/static_vo_tool/viewer.css" />
<link href="$survey_prefix/static/static_vo_tool/css/facebox.css"
	media="screen" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css"
	href="$survey_prefix/static/static_vo_tool/menu.css" />
<style>
#facebox {
	height: 580px;
	overflow-y: auto;
	overflow-x: hidden;
	max-height: 85%;
	max-width: 70%;
	width: 50%;
}
</style>
<script type="text/javascript" src="$survey_prefix/static/js/jquery.js"></script>
<script type="text/javascript"
	src="$survey_prefix/static/js/properties.js"></script>
<script type="text/javascript"
	src="$survey_prefix/static/static_vo_tool/js/jquery.lightbox-0.5.js"></script>
<script
	src="$survey_prefix/static/static_vo_tool/js/jquery-ui-1.8.16.custom.min.js"
	type="text/javascript"></script>
<script type="text/javascript"
	src="$survey_prefix/static/static_vo_tool/js/highcharts.js"></script>
<script src="$survey_prefix/static/static_vo_tool/js/facebox.js"
	type="text/javascript"></script>
<script
	src="$survey_prefix/static/static_vo_tool/js/jquery.dataTables.js"
	type="text/javascript"></script>
<script src="$survey_prefix/static/static_vo_tool/js/ColReorder.js"
	type="text/javascript"></script>
<script src="$survey_prefix/static/static_vo_tool/js/ColVis.js"
	type="text/javascript"></script>
<script type="text/javascript" charset="utf-8"
	src="$survey_prefix/static/static_vo_tool/js/ZeroClipboard.js"></script>
<script type="text/javascript" charset="utf-8"
	src="$survey_prefix/static/static_vo_tool/js/TableTools.js"></script>
<script src="$survey_prefix/static/static_vo_tool/js/highstock.src.js"
	type="text/javascript"></script>
<script type="text/javascript"
	src="$survey_prefix/static/static_vo_tool/js/themes/grid.js"></script>
<script src="$survey_prefix/static/static_vo_tool/menu.js"
	type="text/javascript"></script>
<script src="$survey_prefix/static/js/parser.js" type="text/javascript"
	charset="utf-8"></script>
<script type="text/javascript"
	src="$survey_prefix/static/js/Table_Tools_additional.js"></script>
<script type="text/javascript" src="$survey_prefix/static/js/samp.js"></script>
<script type="text/javascript"
	src="$survey_prefix/static/js/samp_helper.js"></script>
<script src="$survey_prefix/static/js/jquery.jscrollpane.min.js"
	type="text/javascript" charset="utf-8"></script>
<script src="$survey_prefix/static/js/mwheelIntent.js"
	type="text/javascript" charset="utf-8"></script>
<script src="$survey_prefix/static/js/jquery.doubleScroll.js"
	type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">			
        
        /*
         * WFAU Web2.0 Project
         * Author: Stelios Voutsinas
         * Date: July 2012
         * 
         * Javascript Functions and Variables used for the Table Plotter Page, part of the OSA Interface
         * 
         * 
         */
        var giRedraw = false;
  		var oTable;
  		var pathname_divId = '#filepath';
  		
  		/* Check if value is a valid number */
  		function isNumber(n) {
			return !isNaN(parseInt(n)) && isFinite(n);
		}
  		
  		
  		/* Get any Math Expressions from the user input*/

  		function getInputMathExpressions(){
  			var is_math_expr = jQuery('#is_math_expr').val();
			var x_expr = "";
			var y_expr = "";
			var return_pair = null;
		    if (is_math_expr=='True'){
			    var axis_names = jQuery("#container div.highcharts-container svg text.highcharts-title tspan").text();
			    if (axis_names!=null && axis_names!=""){
			   		axis_names = axis_names.split('  ');
					var x_expr = axis_names[0];
				    var y_expr = axis_names[2];
				    return_pair =  [x_expr, y_expr];

			  }
		    }
		    return return_pair;
  		}
        
  		/* Custom TableTools buttons for saving data in different formats */
  		
 		TableTools.BUTTONS.csv_button  = {
				"sAction": "text",
				"sFieldBoundary": "",
				"sFieldSeperator": "\t",
				"sAjaxUrl": "save_as_html",
				"sToolTip": "",
				"sButtonClass": "DTTT_button_text",
				"sButtonClassHover": "DTTT_button_text_hover",
				"sButtonText": "CSV",
				"mColumns": "all",
				"bHeader": true,
				"bFooter": true,
				"fnMouseover": null,
				"fnMouseout": null,
				"fnClick": function( nButton, oConfig ) {
					var xypair = getInputMathExpressions();
					fnSaveAsCustom('csv', oTable, pathname_divId,xypair);
				},
				"fnSelect": null,
				"fnComplete": null,
				"fnInit": null,
				"fnAjaxComplete": function( json ) {
				}
			};
		
		TableTools.BUTTONS.copy_to_fits = {
				"sAction": "text",
				"sFieldBoundary": "",
				"sFieldSeperator": "\t",
				"sAjaxUrl": "save_as_fits",
				"sToolTip": "",
				"sButtonClass": "DTTT_button_text",
				"sButtonClassHover": "DTTT_button_text_hover",
				"sButtonText": "FITS",
				"mColumns": "all",
				"bHeader": true,
				"bFooter": true,
				"fnMouseover": null,
				"fnMouseout": null,
				"fnClick": function( nButton, oConfig ) {
					var xypair = getInputMathExpressions();
					fnSaveAsCustom('fits', oTable, pathname_divId, xypair);					
	
				},
				"fnSelect": null,
				"fnComplete": null,
				"fnInit": null,
				"fnAjaxComplete": function( json ) {
				}
			};
			 
			TableTools.BUTTONS.copy_to_votable = {
					"sAction": "text",
					"sFieldBoundary": "",
					"sFieldSeperator": "\t",
					"sAjaxUrl": "save_as_vot",
					"sToolTip": "",
					"sButtonClass": "DTTT_button_text",
					"sButtonClassHover": "DTTT_button_text_hover",
					"sButtonText": "VOTable",
					"mColumns": "all",
					"bHeader": true,
					"bFooter": true,
					"fnMouseover": null,
					"fnMouseout": null,
					"fnClick": function( nButton, oConfig ) {
						var xypair = getInputMathExpressions();
						fnSaveAsCustom('vo', oTable, pathname_divId,xypair);					
					},
					"fnSelect": null,
					"fnComplete": null,
					"fnInit": null,
					"fnAjaxComplete": function( json ) {
					}
			};
			
			TableTools.BUTTONS.copy_to_html = {
				"sAction": "text",
				"sFieldBoundary": "",
				"sFieldSeperator": "\t",
				"sAjaxUrl": "data_tables_processing",
				"sToolTip": "",
				"sButtonClass": "DTTT_button_text",
				"sButtonClassHover": "DTTT_button_text_hover",
				"sButtonText": "HTML",
				"mColumns": "all",
				"bHeader": true,
				"bFooter": true,
				"fnMouseover": null,
				"fnMouseout": null,
				"fnClick": function( nButton, oConfig ) {
					var xypair = getInputMathExpressions();
					fnSaveAsCustom('html', oTable, pathname_divId,xypair);
				
				},
				"fnSelect": null,
				"fnComplete": null,
				"fnInit": null,
				"fnAjaxComplete": function( json ) {
				}
			};
	
		/* end custom TableTools buttons */
		
		/* Disable right clicks for internal links */
		jQuery('a').live('contextmenu', function(e){
			var input = base_url;
			if (this.href.substring(0, input.length) === input){
				return false;
			} 
		});
		
		/** 
		 * Flatten a float given as a string 
		 *
		 */

 	    function flatten_floatStr (float_as_str) {
	    	var num_list = float_as_str.split('x');
	    	if (num_list.length>1){
	    		var pow_array = num_list[1].split('^');
	    		total = parseFloat(num_list[0]) * parseFloat(Math.pow(pow_array[0],pow_array[1]));
	    		total = total.toString();
	    	} else {
	    		total = float_as_str;
	    	}
	    	return total;  
	     }
	      

		 /** 
		  * Function for toggling minimize links ([+] and [-]) used in webapp 
		  *
		  */
	     function toggle_minimize_button(id_link, id_content, toggle_on, toggle_off){
		  	    if (jQuery(id_link).html() == toggle_on){ 
 			  		jQuery(id_link).html(toggle_off);
 			  	} else {
 			  		jQuery(id_link).html(toggle_on);
 			  	}
     			jQuery(id_content).slideToggle('slow');
      	  }
	      
		  /**
		   * Flatten array
		   *
		   */
	      var flatten = function(arr){
	            var flatten = arguments.callee; // reference to self, in case top-level var name is changed
	            return arr.reduce(function(acc, val){
	                return acc.concat(val.constructor === Array ? flatten(val) : val);
	            },[]);
	      };        
	      
	      var cc;
	      var callHandler;
	      var connector;
	      var tableUrl;
	      var tableId;
	  	  var _broadcast_url;

	  	  
	  	  
	      /*
	       *  
	       * On ready functionality
	       *
	       */
    	   
          jQuery(document).ready(function(){
        	
        	  
        	   /* Samp */
       
        	    cc = new samp.ClientTracker();
        	    callHandler = cc.callHandler;
        		var meta = {
        		    "samp.name": "OSA Results",
        	        "samp.description":
        	        "OSA Interface table results",
        		    "samp.icon.url": "http://surveys.roe.ac.uk/osa/common/img/wfau_browser.gif"
        	        };
        		
        		callHandler["table.highlight.row"] = function(senderId, message, isCall) {
        	    	var params = message["samp.params"];
        		    if (params['table-id']!=tableId) {
	        			return;
        		    }
        		
        		    findRow(params["row"]).css('background-color', 'red');
       	        };
        	    
       	        callHandler["table.select.rowList"] = function(senderId, message, isCall) {
        	        var params = message["samp.params"];
        		    if (params['table-id']!=tableId) {
        				return;
        		    }
        		    jQuery('#votable tr').removeClass("highlight");
        		    for (var idx in params["row-list"]) {
        		        findRow(params["row-list"][idx]).css('background-color', 'red');
        		    }
        	    };
        	        
 		 	    var subs = cc.calculateSubscriptions();
        	    connector = new samp.Connector("OSA Results", meta, cc, subs);

        		setInterval("updateStatus()", 1000);

        		jQuery('#register').click(function(e) {
        		    connector.register();
        		    updateStatus();

        		    return false;
        		});
        		
        		jQuery('#unregister').click(function(e) {
        		    connector.unregister();
        		    updateStatus();
					return false;
        		});

        		
        		/*
        		 * Handle the action of loading a table to SAMPs
        		 */
        		jQuery('#loadvotable').click(function(e) {
      			  
        			var is_math_expr = jQuery('#is_math_expr').val();
					  var x_expr = "";
					  var y_expr = "";
					  
        			  if (is_math_expr=='True'){
						  var axis_names = jQuery("#container div.highcharts-container svg text.highcharts-title tspan").text();
						  if (axis_names!=null && axis_names!=""){
							  axis_names = axis_names.split('  ');
							  x_expr = axis_names[0];
							  y_expr = axis_names[2];
						 }
					  }
       	        	       	      
       	        	 var temp_stored_url = fnSaveAsGetURLforViewer('vo', oTable, pathname_divId, base_url, x_expr, y_expr);
	   				 var xhr = jQuery.ajax({
	        	       type: "POST",
	        	       data: {_broadcast_url : temp_stored_url, _action : "save_as_temp_file"},
	        	       url : base_url +  '/data_tables_processing',
	        	       timeout: 1000000,
	        	       error: function() {
	        	       	alert('There was an error processing your request');
	        	       },
	        	       success: function(data) {
	        	    	   if (data!=null){
	        	    		   temp_stored_url = data;
	        	    	   }
	        	    		
	        	    	   var msg = new samp.Message("table.load.votable",
	     			                        {"table-id": "OSA Query Data",
	     						"url": temp_stored_url,
	     						"name": "OSA Query Data"});
	     	             
	        	    	   connector.connection.notifyAll([msg]);
	        	    	   _broadcast_url =  fnSaveAsGetURLforViewer('vo', oTable, pathname_divId, base_url, x_expr, y_expr);
	        	       }
	        	 	});
        		   
	   				return false;
        		   
        		});
        		
        		
        		
        		/**
        		 * Send a Samp Message to highlight a row by its index (trNumber)
        		 *
        		 */
        		function SAMPRowClickHandler(trNumber){
        			
        			if (!!!connector.connection) {
        			    return;
        			}
        			jQuery(this).addClass('highlight');
        			rowIdx = trNumber;
        			if ( isNaN(rowIdx) ) {
        			    return;
        			}
        			
        			var is_math_expr = jQuery('#is_math_expr').val();
					var x_expr = "";
					var y_expr = "";
					  
     				if (is_math_expr=='True'){
					  var axis_names = jQuery("#container div.highcharts-container svg text.highcharts-title tspan").text();
					  if (axis_names!=null && axis_names!=""){
						  axis_names = axis_names.split('  ');
						  x_expr = axis_names[0];
						  y_expr = axis_names[2];
					  }
				  	}
     				
     			
     			      
        			var msg = new samp.Message("table.highlight.row",
                               {"table-id": "OSA Query Data",
     					       "url": fnSaveAsGetURLforViewer('vo', oTable, pathname_divId, base_url, x_expr, y_expr),
     					       "row": ""+rowIdx});
     	                connector.connection.notifyAll([msg]);
     	               
     	                
        		}
        		
        		/**
        		 * Send a Samp Message to highlight a row list (index_list)
        		 *
        		 */
        		function SAMPRowListClickHandler(index_list){
        			
        			if (!!!connector.connection) {
        			    return;
        			}
        			
        			var is_math_expr = jQuery('#is_math_expr').val();
					var x_expr = "";
					var y_expr = "";
					  
     				if (is_math_expr=='True'){
					  var axis_names = jQuery("#container div.highcharts-container svg text.highcharts-title tspan").text();
					  if (axis_names!=null && axis_names!=""){
						  axis_names = axis_names.split('  ');
						  x_expr = axis_names[0];
						  y_expr = axis_names[2];
					  }
				  	}
     			
                    
     				var msg = new samp.Message("table.select.rowList",
    	                               {"table-id": "OSA Query Data",
                    	 				"url": fnSaveAsGetURLforViewer('vo', oTable, pathname_divId, base_url, x_expr, y_expr),
    				       				"row-list": index_list.map(function(x){return x.toString()})});
                  
     	            connector.connection.notifyAll([msg]);
     	               
     	                
        		}
        		

        	 jQuery(window).unload( function () { connector.unregister(); } ); 
        	
        	 
			 /**
			  * Get a List of Row indexes for a given selection or filtering of points in a dataTables object
			  *
			  */
			  jQuery.fn.dataTableExt.oApi.fnGetRowIndexes = function( oSettings, oData , base_url, pathname, math_expr) {

        		if (!math_expr){
	        	 	for ( var key in oData ) {
	        	         if ( oData.hasOwnProperty(key) ) {
	        	             for ( var i=0, iLen=oSettings.aoColumns.length ; i<iLen ; i++ ) {
	        	             	
	        	                 if( oSettings.aoColumns[i].sTitle.toLowerCase() == key.toLowerCase() ) {
	        	                 	
	        	                     /* Add single column filter */
	        	                     oSettings.aoPreSearchCols[ i ].sSearch = oData[key];
	        	                     break;
	        	                 }
	        	             }
	        	         }
	        	     }
	        	 	
        		} else {
        		    var axis_strings = "";
        		    
        			for ( var key in oData ) {
        		        if ( oData.hasOwnProperty(key) ) {
        					if (oData[key].indexOf('|')>0){
        						if (oData[key]!="" && oData[key]!=null){
        							axis_strings += oData[key] + '_'
        						}
        					} else {
        						if (oData[key]!="" && oData[key]!=null){
        		        			axis_strings += oData[key] + '|';
        						}
        					}    
        		        }
        		    }
        			
        			if (axis_strings!=""){
        		    	axis_strings = axis_strings.slice(0,axis_strings.length-1);
        			}
        			
        		    for ( var key in oData ) {
        		        if ( oData.hasOwnProperty(key) ) {
        		        	var expr = Parser.parse(key);
        		       		var variables = expr.variables();
        		        	for ( var i=0, iLen=oSettings.aoColumns.length ; i<iLen ; i++ ) {
        		        		for ( var x =0;x<variables.length; x++ ) {
        			        	   if ( oSettings.aoColumns[i].sTitle.toLowerCase() == variables[x].toLowerCase() ) {
        			        		   oSettings.aoPreSearchCols[ i ].sSearch = axis_strings;
        			                     break;
        			      		   }
        		        		}
        		            }
        					     
        		       	}
        		    }
        		    
        		}
        		
        	 	var index_list = [];
        	 	var sData = this.fnSettings();
        	 	var params = this.oApi._fnAjaxParameters(sData);
        	 	var pathname = jQuery(pathname).val();
       	 	    var is_math_expr = jQuery('#is_math_expr').val();
       	 	    
			    if (is_math_expr=='True'){
				    var axis_names = jQuery("#container div.highcharts-container svg text.highcharts-title tspan").text();
				    if (axis_names!=null && axis_names!=""){
				   		axis_names = axis_names.split('  ');
						var x_expr = axis_names[0];
					    var y_expr = axis_names[2];
					    params.push({'name' : 'x_expr', 'value' : x_expr});
					    params.push({'name' : 'y_expr', 'value' : y_expr});
				  }
			    }
        	 	
			    params.push({'name' : 'pathname', 'value' : pathname});
				params.push({'name' : '_broadcast_url', 'value' : _broadcast_url});			    
        	 	var xhr = jQuery.ajax({
        	       type: "POST",
        	       data : params,
        	       url :  base_url +  '/data_tables_processing',
        	       timeout: 1000000,
        	       error: function() {
        	       	alert('There was an error processing your request');
        	       },
        	       success: function(data) {
	        	   		try {
	        	   			
	        	   			if (data!=""){
				      	     	  var parsed_data = jQuery.parseJSON(data);
				    	     	  index_list = parsed_data['index_list'];
				    	     	  if (index_list.length==1){
				     	     		 SAMPRowClickHandler(index_list[0].toString());  
				     	     	  } else if (index_list.length>1){
				     	     		 SAMPRowListClickHandler(index_list);
				     	     	  }
	        	   			} 

	        	   		} catch (err){
							console.log(err);
	        	   		}
        	       }
        	 	}); 
        	 	
        	 	
        	 }
			 
        	 /* end samp */
        	  
         	jQuery('a[rel*=facebox]').facebox();  // Initialize facebox links 

 
        	// Variables used for scatter plot 
            var maxDensity = 2;
            var numBinsX = 35;
            var imgPath = "http://www.stlukeseye.com/images/img-amsler-grid.gif";
            var imgPosX = 11.8;
            var imgPosY = 11.8;
            var imgWidth = 0.1;
            var imgHeight = 0.1;
         	var DEFAULT_MARKER_COLOR = 'rgba(0, 0, 0, 0)';
      	    SELECTED_MARKER_COLOR = 'rgba(210,30,100,.9)'
      	    MARKER_COLOR = { red: 'rgba(255, 0, 0, .7)',
      	                     green: 'rgba(0, 255, 0, .7)',
      	                     blue: 'rgba(0, 0, 255, .7)',
      	                     yellow: 'rgba(220, 220, 0, .7)',
      	                     unselect: DEFAULT_MARKER_COLOR
      	                    }
      		var chart;
      	    var primitiveObjects = [] // References to the primitive objects drawn on the chart
      	    var originalSizeX;		  // Size variables for the background image
      	    var originalMinX;
      	    var originalSizeY;
      	    var originalMinY;
      	    var numBinsY;             // The number of y bins is automatically adjusted according to numBinsX so that the bins are square
      	    var dataExtremes;         // Find the extremes of the dataset to be plotted to set the initial window bounds
      	    var bins;                 // Holds information about the density of each part of the plot
      	    var currentDatasetName = ""; // The name of the dataset to be loaded
      	    myFields = { }				     // Pointers to HTML fields on the page
      	    dataToPlot = [];

            /**
             * Find the domain and range max and min of a dataset 
             *
             */
            function getDataExtremes(data) {
            	var extremes = { range: {
            		min: Number.MAX_VALUE,
            		max: Number.MIN_VALUE
            	},
            	domain: {
            		min: Number.MAX_VALUE,
            		max: Number.MIN_VALUE
            	}
            	};
            	// Loop through the data and find the min and max values
            	for (var i = 0; i < data.length; i++) {
    		
            		// Domain
            		if (data[i][0] < extremes.domain.min) {
            			extremes.domain.min = data[i][0];
            		}
            		if (data[i][0]<=0 && extremes.domain.max==Number.MIN_VALUE){
            			extremes.domain.max = data[i][0];
            		} else { 
	            		if (data[i][0] > extremes.domain.max) {
	            			extremes.domain.max = data[i][0];
	            		}	
            		}
            	
            		// Range
            		if (data[i][1] < extremes.range.min) {
            			extremes.range.min = data[i][1];
            		}
            		
            		if (data[i][1]<=0 && extremes.range.max==Number.MIN_VALUE){
            			extremes.range.max = data[i][1];
            		} else { 
	            		if (data[i][1] > extremes.range.max) {
	            			extremes.range.max = data[i][1];
	            		}
            		}
            	}
            	if (extremes.domain.max ==extremes.domain.min ){
            		extremes.domain.max = extremes.domain.min + 1; 
            	} 
            	if (extremes.range.max ==extremes.range.min ){
            		extremes.range.max = extremes.range.min + 1; 
            	} 
            	return extremes;
            }
            	
            /**
             * Breaks the scatter plot data up into a 2d array of bins, like a density plot
             *
             */
            function getBins(data) {

              	// Get the extremes for each axis to determine the vertices of each bin
              	var domainExtremes = chart.xAxis[0].getExtremes();
              	var rangeExtremes = chart.yAxis[0].getExtremes();
				
              	// Set the width and height of each box
              	var binHeight = (domainExtremes.max-domainExtremes.min)/numBinsX;
              	var binWidth = (rangeExtremes.max-rangeExtremes.min)/numBinsY;

              	// Initalize the 2D array of bins, set inital values to 0	
              	var _bins = new Array(numBinsX);
              	for (var i = 0; i < numBinsX; i++) {
              		_bins[i] = new Array(numBinsY);
              	}
              	for (var row = 0; row < numBinsX; row++) {
              		for (var col = 0; col < numBinsY; col++) {
              			_bins[row][col] = new Array();
              		}
              	}
              
              	// Loop through the data points and place each one in the correct bin
              	for (var i = 0; i < data.length; i++) {
              		// Determine the correct x and y bin to place this data element into
              		var xBin = Math.floor(((data[i][0] - domainExtremes.min)/
              				(domainExtremes.max-domainExtremes.min))*numBinsX);
              		var yBin = Math.floor(((data[i][1] - rangeExtremes.min)/
              				(rangeExtremes.max-rangeExtremes.min))*numBinsY);
              	
              		// Push this data point onto the array of bins in the correct place
              		try {
              			_bins[xBin][yBin].push(data[i]);
              		} catch (err){
              			try {
                  			_bins[xBin-1][yBin].push(data[i]);
                  		} catch (err2){
                  		}
              		}

              	}
      			
              	return _bins;
            }
              	
            /** 
             * Determine which points in the current plot window are in areas 
             * of low enough density to be plotted individually 
             *
             */
           function getIndividualPts(data) {

              	// The individual points that are sparse enough to be plotted
              	var pointsToPlot = [];

              	// Get the extremes for each axis
              	var domainExtremes = chart.xAxis[0].getExtremes();
              	var rangeExtremes = chart.yAxis[0].getExtremes();
		
              	for (var i = 0; i < data.length; i++) {	
              		// Figure out which bin this point belongs in
              		var xBin = Math.floor(((data[i][0] - domainExtremes.min)/
              				(domainExtremes.max-domainExtremes.min))*bins.length);
              		var yBin = Math.floor(((data[i][1] - rangeExtremes.min)/
              				(rangeExtremes.max-rangeExtremes.min))*bins[0].length);
              		
              		try {
              			// Add this point to the plot list if the bin is not over the density limit
      	        		if (bins[xBin][yBin].length <= maxDensity) {
      	        			pointsToPlot.push(data[i]);
      	        		}
              		} catch (err){
              			try {
                 			// Add this point to the plot list if the bin is not over the density limit
          	        		if (bins[xBin-1][yBin].length <= maxDensity) {
          	        			pointsToPlot.push(data[i]);
          	        		}
                  		} catch (err2){
                  		}
                	}
      	        	
              	}

              	return pointsToPlot;
            }
              	
              
            /**
             * Draw the rectangles and points on the plot 
             *
             */
            function drawData(sparsePts, axis, is_mixed_plot) {	
				
            	//reset 
            	jQuery('#point_notification').slideUp('slow');	 
				jQuery('#density_notification').html("").slideUp('slow');
				if (oTable!=null) {
					fnResetAllFilters(oTable);
				}
				
              	// An array that stores references to all of the primitive objects created
              	var primitiveObjects = [];
				
              	if (is_mixed_plot == true) {
	              	// Figure out how many pixels large each bin is
	              	var binPixelWidth = chart.plotWidth/bins.length;
	              	var binPixelHeight = chart.plotHeight/bins[0].length;
	              	
	              	// Find the range of densities in the graph
	              	var largestDensity = Number.MIN_VALUE;
	              	for (var i = 0; i < bins.length; i++) {
	              		for (var j = 0; j < bins[0].length; j++) {
	              			if (bins[i][j].length > largestDensity) {
	              				largestDensity = bins[i][j].length;
	              			}
	              		}
	              	}
	              	var densityRange = largestDensity - maxDensity;
		
	              
	              	// Draw the rectangles over areas with high density
	              	for (var i = 0; i < bins.length; i++) {
	              		for (var j = 0; j < bins[0].length; j++) {
	              		
	              			if (bins[i][j].length > maxDensity) {
	              	
	              				// Scale the opacity of the fill color based on the density
	              				var fillColor = 'rgba(50,50,50,'+ ((bins[i][j].length - maxDensity)/densityRange) +')';
	              				
	              				var xPos = i*binPixelWidth+chart.plotLeft;
	              				var yPos = chart.plotHeight+chart.plotTop-binPixelHeight-j*binPixelHeight;
	              				
	              				var strokeWidth = 0;
	              				var strokeColor = '#0000FF';
	              				// Bins with selected points have a border
	              				var xMax = bins[i][j][0][0];
	              				var yMax = bins[i][j][0][1];
	              				var xMin = bins[i][j][0][0];
	              				var yMin = bins[i][j][0][1];
	              				
	              				for (var k = 0; k < bins[i][j].length; k++) {
	              					
	              					if (bins[i][j][k][0]>xMax){
	              						xMax = bins[i][j][k][0];
	              					}
	              					
	              					if (bins[i][j][k][1]>yMax){
	              						yMax = bins[i][j][k][1];
	              					}
	              					
	              					if (bins[i][j][k][0]<xMin){
	              						xMin = bins[i][j][k][0];
	              					}
	              					
	              					if (bins[i][j][k][1]<yMin){
	              						yMin = bins[i][j][k][1];
	              					}
	              					
	              					if (bins[i][j][k].color != DEFAULT_MARKER_COLOR) {
	              						strokeWidth = 2;
	              						strokeColor = 'gray';
	              						//break;
	              					}
	              				}
	              			
	              			
	              				
	              				primitiveObjects.push(chart.renderer.rect(xPos,yPos,binPixelWidth,binPixelHeight,0)
	              									.attr({density: bins[i][j].length.toString(), stroke: strokeColor,selected: 'False','stroke-width': strokeWidth,fill: fillColor,zIndex: 1,xMax : xMax.toString(),yMax : yMax.toString(),xMin : xMin.toString(),yMin : yMin.toString() }).on('click', function(){

	
	              										var selected = jQuery(this)[0].attributes.selected.value;
	              			      					 	
	              			      					 	if (selected=='True'){
	              			      					 		 jQuery('#point_notification').slideUp('slow');	 
		                			      					 jQuery('#density_notification').slideUp('slow');
	              			      					 		 jQuery(this)[0].attributes.selected.value = 'False';
	              			       				    		 jQuery(this)[0].attributes['stroke'].value = 'gray';
	              			       				    		 
	              			      					 	 } else {
	              			      					 	     resetPointSelections();
		   	              					        	   //  fnResetAllFilters(oTable);


	        	        var pairData = {};
	        	        if (axis[0]==axis[1]){
	        	        	axis[1] = axis[1] + '__B';
	        	        }
		        	    pairData[axis[0]] = "";
    				 	pairData[axis[1]] = "";
    				 	
    				 	var ongoing_filter = true;


    					// Check which data points are inside the selection box
            			for (var i = 0; i < dataToPlot.length; i++) {

            				if (dataToPlot[i][0] <= xMax && dataToPlot[i][0] >= xMin) {
            					if (dataToPlot[i][1] <=yMax && dataToPlot[i][1] >=  yMin) {
            						pairData[axis[0]] += String(dataToPlot[i][0]) + '|';
    	        				 	pairData[axis[1]] += String(dataToPlot[i][1]) + '|';
            						
									var circle = jQuery('circle').filter(function() {
                						
        		        				var dataX = jQuery(this).attr('dataX');
        		        	            var dataY = jQuery(this).attr('dataY');
        		        	          	
        		        	        	return (dataX==dataToPlot[i][0] && dataY==dataToPlot[i][1]);
        		        	           
        		        	        });

			 			
						if (circle[0]!=null){
            			        			var selected = jQuery(circle)[0].attributes.selected.value;
            							 	if (selected=='True' && ongoing_filter!=true){
            						    			 jQuery(circle)[0].attributes.selected.value = 'False';
            						    		 	jQuery(circle)[0].attributes['fill-opacity'].value = '0.6';
									 	jQuery(circle)[0].attributes['fill'].value ='rgb(119,152,191)';
            							 	 } else {
							 			jQuery(circle)[0].attributes['fill'].value = 'rgb(52,236,46)';
            				      	    		 		jQuery(circle)[0].attributes['fill-opacity'].value = '0.9';
            						    		 	jQuery(circle)[0].attributes.selected.value = 'True';
            							 	 }
            		        		} else {
            		        				
            		        			rect = jQuery('rect').filter(function() {
            		        	          	
            		        				var xMax = jQuery(this).attr('xMax');
            		        	            var xMin = jQuery(this).attr('xMin');
            		        	            var yMax = jQuery(this).attr('yMax');
            		        	            var yMin = jQuery(this).attr('yMin');
            		        	            if (xMax!=null && yMax!=null && xMin!=null && yMin!=null){
            		        	          	  	return parseFloat(dataToPlot[i][0]) >= parseFloat(xMin) && parseFloat(dataToPlot[i][0]) <= parseFloat(xMax) && parseFloat(dataToPlot[i][1]) <= parseFloat(yMax) && parseFloat(dataToPlot[i][1]) >= parseFloat(yMin);
            		        	            } else{
            		        	            	return false;
            		        	            }

            		        	        });
            		        			
            		        			try {
            		     					jQuery(rect)[0].attributes.selected.value ='True';
	            		        			jQuery(rect)[0].attributes['stroke'].value = 'rgb(119,152,191)';
	            		        		} catch (err){
	            		        			console.log(err);
	            		        		}
            		        		}
            						
            					}
            				}
            			}
    					
    				 	ongoing_filter = false;
            			pairData[axis[0]] = pairData[axis[0]].substring(0, pairData[axis[0]].length - 1);
            			pairData[axis[1]] = pairData[axis[1]].substring(0, pairData[axis[1]].length - 1);
            			
            			var is_math_expr = jQuery('#is_math_expr').val();
            			
            			if (is_math_expr == 'True'){
            				oTable.fnMultiEvalFilter(pairData);
    			    		oTable.fnGetRowIndexes( pairData,  base_url ,pathname_divId, true);

            			} else {
            				oTable.fnMultiFilter(pairData);
    			    		oTable.fnGetRowIndexes( pairData,  base_url ,pathname_divId, false);
    			    		
            			}





	              				      		                 jQuery('#point_notification').slideDown('slow');
	              				      		                 jQuery('#density_notification').html('Density: ' + jQuery(this)[0].attributes['density'].value).slideDown('slow');
	              				      			    		 jQuery(this)[0].attributes['stroke'].value = 'rgb(119,152,191)';
	              				      			    		 jQuery(this)[0].attributes.selected.value = 'True';
	              			      					 	 }
	              										
	              									}).add());
	              			}
	              		}
	              	}
	              	
            	}

              	// Draw the individual points in areas with low density
              	for (var i = 0; i < sparsePts.length; i++) {
              		
              		var xPos = chart.xAxis[0].translate(sparsePts[i][0])+chart.plotLeft;
              		var yPos = chart.plotHeight-chart.yAxis[0].translate(sparsePts[i][1])+chart.plotTop;
              	    primitiveObjects.push(chart.renderer.circle(xPos,yPos,3).attr({dataX : sparsePts[i][0], dataY : sparsePts[i][1], selected : 'False', fill: 'rgba(119, 152, 191, .7)',zIndex: 100}).on('click', function(){
      					 	
		              		var selected = jQuery(this)[0].attributes.selected.value;
      					 	if (selected=='True'){
      					 		 jQuery('#point_notification').slideUp('slow');	 
  	     				    		 fnResetAllFilters(oTable);
  	     				    		 jQuery(this)[0].attributes.selected.value = 'False';
  	     				    		 jQuery(this)[0].attributes['fill-opacity'].value = '0.6';
							jQuery(this)[0].attributes['fill'].value ='rgb(119,152,191)';
      					 	 } else {
      					 		 resetPointSelections();
				        	     var x = jQuery(this)[0].attributes.dataX.value;
	      					 	 var y = jQuery(this)[0].attributes.dataY.value;
	        				 	 var temp_arr = json_array.join("`").toLowerCase().split("`");
	        				 	 var colXname = axis[0];
	        				 	 var colYname = axis[1];
	        				 	 var pairData = {};
	        				 	 pairData[colXname] = String(x);
	        				 	 pairData[colYname] = String(y);
	        				 	 var is_math_expr = jQuery('#is_math_expr').val();
	        				 	 if (is_math_expr == 'True'){
	        				 		 oTable.fnMultiEvalFilter( pairData );
	        				 	     jQuery('#point_notification').slideDown('slow');
		      			    		 jQuery(this)[0].attributes['fill-opacity'].value = '0.9';
							 jQuery(this)[0].attributes['fill'].value = 'rgb(52,236,46)';
		      			    		 jQuery(this)[0].attributes.selected.value = 'True';
		      			    		 oTable.fnGetRowIndexes( pairData,  base_url ,pathname_divId, true);

	        				 	 } else {
		        				 	 oTable.fnMultiFilter( pairData );
		      		                         jQuery('#point_notification').slideDown('slow');
							 jQuery(this)[0].attributes['fill'].value = 'rgb(52,236,46)';
		      			    		 jQuery(this)[0].attributes['fill-opacity'].value = '0.9';
		      			    		 jQuery(this)[0].attributes.selected.value = 'True';
		      			    		 oTable.fnGetRowIndexes( pairData,  base_url ,pathname_divId, false);
		        				 }
	        				 	
	        				
	        				 	 
      					 	 }
      				}).add());	
              		
              	}
              	 
              	return primitiveObjects;
              	
              }
			
             /**
              * Check if Radio Zoom option is selected
              *
              */
              function isRadioZoom(){
            	 
            	  var radioSelectVal = jQuery('input:radio[name=radSelectZoom]:checked').val();
				  if (radioSelectVal=='select'){
            	  	return false;
				  } else {
					return true;
				  }
              }
              
              /**
               * What to do when a selection is made 
               *
               */
              function handleSelectEvent(chart,event, axis) {
					
            		if (!isRadioZoom() && ("xAxis" in event)) {
            			event.preventDefault();
            			
            		
		        	 	resetPointSelections();
	        	        var pairData = {};
	        	        if (axis[0]==axis[1]){
	        	        	axis[1] = axis[1] + '__B';
	        	        }
		        	    pairData[axis[0]] = "";
    				 	pairData[axis[1]] = "";
    				 	
    				 	var ongoing_filter = true;
    					// Check which data points are inside the selection box
            			for (var i = 0; i < dataToPlot.length; i++) {
            			
            				if (dataToPlot[i][0] < event.xAxis[0].max && dataToPlot[i][0] > event.xAxis[0].min) {
            					if (dataToPlot[i][1] < event.yAxis[0].max && dataToPlot[i][1] > event.yAxis[0].min) {
            						pairData[axis[0]] += String(dataToPlot[i][0]) + '|';
    	        				 	pairData[axis[1]] += String(dataToPlot[i][1]) + '|';
            						
									var circle = jQuery('circle').filter(function() {
                						
        		        				var dataX = jQuery(this).attr('dataX');
        		        	            var dataY = jQuery(this).attr('dataY');
        		        	          	
        		        	        	return (dataX==dataToPlot[i][0] && dataY==dataToPlot[i][1]);
        		        	           
        		        	        });

			 			
						if (circle[0]!=null){
            			        			var selected = jQuery(circle)[0].attributes.selected.value;
            							 	if (selected=='True' && ongoing_filter!=true){
            						    			 jQuery(circle)[0].attributes.selected.value = 'False';
            						    		 	jQuery(circle)[0].attributes['fill-opacity'].value = '0.6';
									 	jQuery(circle)[0].attributes['fill'].value ='rgb(119,152,191)';
            							 	 } else {
							 			jQuery(circle)[0].attributes['fill'].value = 'rgb(52,236,46)';
            				      	    		 		jQuery(circle)[0].attributes['fill-opacity'].value = '0.9';
            						    		 	jQuery(circle)[0].attributes.selected.value = 'True';
            							 	 }
            		        		} else {
            		        				
            		        			rect = jQuery('rect').filter(function() {
            		        	          	
            		        				var xMax = jQuery(this).attr('xMax');
            		        	            var xMin = jQuery(this).attr('xMin');
            		        	            var yMax = jQuery(this).attr('yMax');
            		        	            var yMin = jQuery(this).attr('yMin');
            		        	            if (xMax!=null && yMax!=null && xMin!=null && yMin!=null){
            		        	          	  	return parseFloat(dataToPlot[i][0]) >= parseFloat(xMin) && parseFloat(dataToPlot[i][0]) <= parseFloat(xMax) && parseFloat(dataToPlot[i][1]) <= parseFloat(yMax) && parseFloat(dataToPlot[i][1]) >= parseFloat(yMin);
            		        	            } else{
            		        	            	return false;
            		        	            }
            		        	        });
            		        			
            		        			try {
            		     					jQuery(rect)[0].attributes.selected.value ='True';
	            		        			jQuery(rect)[0].attributes['stroke'].value = 'rgb(119,152,191)';
	            		        		} catch (err){
	            		        			console.log(err);
	            		        		}
            		        		}
            						
            					}
            				}
            			}
    					
    				 	ongoing_filter = false;
            			pairData[axis[0]] = pairData[axis[0]].substring(0, pairData[axis[0]].length - 1);
            			pairData[axis[1]] = pairData[axis[1]].substring(0, pairData[axis[1]].length - 1);
            	
            			var is_math_expr = jQuery('#is_math_expr').val();
            		
            			if (is_math_expr == 'True'){
            				oTable.fnMultiEvalFilter(pairData);
    			    		oTable.fnGetRowIndexes( pairData,  base_url ,pathname_divId, true);

            			} else {
            				oTable.fnMultiFilter(pairData);
    			    		oTable.fnGetRowIndexes( pairData,  base_url ,pathname_divId, false);
    			    		
            			}
            		}
            	}
            		
              	
              /** 
               * What to do when the plot is loaded 
               *
               */
              function handleLoadEvent(chart) {
              
              	// Set the number of y bins so that the bins stay square
              	numBinsY = Math.ceil(numBinsX * (chart.plotHeight/chart.plotWidth));
              	// Record the scale and minimums of the axes so the background can be resized accordingly later on
                 originalMinX = chart.xAxis[0].getExtremes().min;
                 originalSizeX = chart.xAxis[0].getExtremes().max - originalMinX;
                 originalMinY = chart.yAxis[0].getExtremes().min;
                 originalSizeY = chart.yAxis[0].getExtremes().max - originalMinY;
              }
              	
              /** 
               * What to do when the plot is redrawn
               *
               */
              function handleRedrawEvent(chart, axis, is_mixed_plot) {
            
              	// Remove all of the exisiting primitive objects
                 for (var i = 0; i < primitiveObjects.length; i++) {
                    primitiveObjects[i].destroy();
                 }
                 
            
              	// Figure out which data points fall within the current window of the plot
                 var pointsInBounds = [];
              	
                 for (var i = 0; i < dataToPlot.length; i++) {
	                 	if (dataToPlot[i][0] >= chart.xAxis[0].getExtremes().min && 
	                    	dataToPlot[i][0] <= chart.xAxis[0].getExtremes().max &&
	                       dataToPlot[i][1] >= chart.yAxis[0].getExtremes().min &&
	                       dataToPlot[i][1] <= chart.yAxis[0].getExtremes().max) {
	                       pointsInBounds.push(dataToPlot[i]);
	                   	}
                 }
         
                // Determine the density of each part of the plot
              	bins = getBins(pointsInBounds);
               
                
                if (!is_mixed_plot) {
                	// Draw the rectangles and points
                    primitiveObjects = drawData(pointsInBounds,axis,is_mixed_plot);    	
                } else {
                	// Figure out which points to draw individually
                  	var sparsePoints = getIndividualPts(pointsInBounds);
                  	// Draw the rectangles and points
                    primitiveObjects = drawData(sparsePoints,axis,is_mixed_plot);
                	
                }
                
              	
              }
                
            /**
             * Reset point selections 
        	 *
        	 */
            function resetPointSelections(){
        		
        		jQuery.each(jQuery('circle'), function(i, val) {
        	 		if (this.attributes.selected!=null){
	        	    	if (jQuery(this)[0].attributes.selected.value == 'True'){
					         jQuery('#point_notification').slideUp('slow');	 
				    		 jQuery(this)[0].attributes.selected.value = 'False';
				    		 jQuery(this)[0].attributes['fill-opacity'].value = '0.6';
						 jQuery(this)[0].attributes['fill'].value ='rgb(119,152,191)';
						}
        	 		}
        	    });

        	    jQuery.each(jQuery('rect'), function(i, val) {
        	    	if (this.attributes.selected!=null){
	        	    	 if (jQuery(this)[0].attributes.selected.value == 'True'){
        	    			jQuery('#point_notification').slideUp('slow');	 
        	    			jQuery('#density_notification').html("").slideUp('slow');
				 		 	jQuery(this)[0].attributes.selected.value = 'False';
				 		 	jQuery(this)[0].attributes['stroke'].value = 'gray';
	        	    	 }	
        	    	}		        	   
        	    });
        	}    
        	
            
            /* 
             * When onReady, check for plot type, and display according form input 
             *
             */
			if (jQuery('#plot_type').val()== "Histogram"){
				jQuery('#xBins_container').hide();
				jQuery('#inverted').hide();
				jQuery("#y_axis").attr("disabled", "disabled");
				jQuery("#y_alias").attr("disabled", "disabled");
				jQuery('#bins_container').fadeIn('fast');
			} else if (jQuery('#plot_type').val() == "Scatter" && jQuery("#mode_notify").html() == "interactive"){
				jQuery('#xBins_container').hide();
				jQuery('#inverted').fadeIn('fast');
				jQuery('#bins_container').hide();
			} else if (jQuery('#plot_type').val() == "Mixed" && jQuery("#mode_notify").html() == "interactive"){
				jQuery('#inverted').fadeIn('fast');
				jQuery('#xBins_container').fadeIn('fast');
			}    
        	 
            /**
             * When interactive is clicked reset density and display bin input 
       	     * 
       	  	 */
            jQuery('#interactive').live('click',function(){ 
				jQuery('#mode_notify').html('interactive').hide().fadeIn('slow');
				jQuery("#plot_type option[value='Density']").remove();
       	 		if (jQuery('#plot_type').val() == "Mixed"){
					jQuery('#xBins_container').fadeIn('fast');
					jQuery('#inverted').fadeIn('fast');
       	 		}
       	 		
       	 		if (jQuery('#plot_type').val() == "Scatter"){
       	 			jQuery('#inverted').fadeIn('fast');
       	 		}
       	 		
       	 		var exists_density = false;
       	 		
    			jQuery('#plot_type option').each(function(){
    			    if (this.value == 'Mixed') {
    			        exists_density = true;
    			    }
    			});
    			
    			if (!exists_density){
    				jQuery('#plot_type').append('<option value="Mixed">Mixed Scatter/Density</option>');
    			}

       	    });  
			
            /**   
             * Reset table and point selections on submit click 
        	 *
        	 */
            jQuery('.radio_select input[type=submit]').live('click',function(){ 
        		fnResetAllFilters(oTable);
        		resetPointSelections();
    	    });  
       	  
            /** 
             * On plot expression link click, toggle the post-it example div 
    		 *
    		 */
            jQuery('#plot_expression_help_link').live('click',function(){ 
    		  	if (jQuery('#plot_expression_help_link').html() == '[+]'){ 
			  		jQuery('#plot_expression_help_link').html('[-]');
			  	} else {
			  		jQuery('#plot_expression_help_link').html('[+]');
			  	}
    			jQuery('#post-it-example').slideToggle('slow');
			  
      	    });
       	    
            /**
             * On static click, hide bin container, and add density input 
			 *
			 */
            jQuery('#static').live('click',function(){ 
    			jQuery('#xBins_container').hide();
       	 		
    			jQuery('#mode_notify').html('static').hide().fadeIn('slow');
				jQuery("#plot_type option[value='Mixed']").remove();

       	    	var exists_density = false;
    			jQuery('#plot_type option').each(function(){
    			    if (this.value == 'Density') {
    			        exists_density = true;
    			    }
    			});
    			if (jQuery('#plot_type').val() == "Scatter"){
       	 			jQuery('#inverted').fadeIn('fast');
    			} else {
    				jQuery('#inverted').hide();
    			}
    			
    			if (!exists_density){
    				jQuery('#plot_type').append('<option value="Density">Density</option>');
    			}
       	    }); 
       	    
       	    /** 
       	     * On Plot Type change, adjust inputs displayed 
       	     *
       	  	 */
       	    jQuery('#plot_type').live('change',function(){ 
				if (jQuery(this).val()== "Histogram"){
					jQuery('#xBins_container').hide();
					jQuery("#y_axis").attr("disabled", "disabled");
					jQuery("#y_alias").attr("disabled", "disabled");
    				jQuery('#inverted').hide();
					jQuery('#bins_container').fadeIn('fast');
				} else if (jQuery(this).val()== "Mixed"){
					jQuery('#bins_container').hide();
					jQuery("#y_axis").attr("disabled", "");
					jQuery("#y_alias").attr("disabled", "");					
					jQuery('#xBins_container').fadeIn('fast');
    				jQuery('#inverted').fadeIn('fast');
				} else if (jQuery(this).val()== "Scatter"){
					jQuery('#bins_container').hide();
					jQuery('#xBins_container').hide();
					jQuery("#y_axis").attr("disabled", "");
					jQuery("#y_alias").attr("disabled", "");					
					jQuery('#inverted').fadeIn('fast');
				} else {
					jQuery('#xBins_container').hide();
					jQuery('#bins_container').hide();
					jQuery("#y_axis").attr("disabled", "");
					jQuery("#y_alias").attr("disabled", "");		
				}
					
       	    });  
      	    

            /**
    		 * Split a space delimited value
    		 * 
    		 */
    		function split( val ) {
    			return val.split(' ');
    		}
    		
    		
    		/**
    		 * Extract the last value from (term)
    		 * 
    		 */
    		function extractLast( term ) {
    			return_val = split( term ).pop() 
    			if (return_val.indexOf(',')>-1){
    				return_val = return_val.split(',').pop();
    			}
    			return return_val;
    		}
    		
    		/**
    		 * Extract the table values from (term) 
    		 * 
    		 */
    		function extractTables (term) {
				var line = term;
    		    var table_list = [];
    		    table_names = json_array;
    		    for (x in table_names) {
					if ((term.indexOf(" "+ table_names[x]+ " ")>-1) || (term.indexOf(" "+ table_names[x]+ ",")>-1)						
				       || (term.indexOf(","+ table_names[x]+ " ") >-1) ||						
					   (term.indexOf(","+ table_names[x] + ",") >-1)){
						 table_list.push (table_names[x]);
					 }						
				}
    		    return table_list;
    		}


    		/**
    		 * Initialise the auto-complete functionality
    		 * When user types into the query box, provide suggestions based on stored values
    		 * 
    		 */
    		function init_autocomplete (input_string){
        		jQuery( input_string )
        		// don't navigate away from the field on tab when selecting an item
       			.bind( "keydown", function( event ) { 

       				if ( event.keyCode === jQuery.ui.keyCode.TAB &&
       						jQuery( this ).data( "autocomplete" ).menu.active ) {
       					event.preventDefault();
       				}
       			})
       			.autocomplete({
       				minLength: 0,
       				source: function( request, response ) {
       					if (extractLast(request.term)==''){
       						return false;
       					}
       					// delegate back to autocomplete, but extract the last term
       					var tables = extractTables(request.term);
       					if (tables.length>0) {

       						var filteredArray = jQuery.map(tags, function(item) {
	       						if( item.startsWith( extractLast(request.term))){
						        	return item;
						        } else {
						            return null;
						        }
						    });
       						
       					} else {

	       					var filteredArray = jQuery.map(availableTags, function(item) {
								if( item.startsWith( extractLast(request.term))){
						        	return item;
						        } else {
						            return null;
						        }
						    });
       					}
       					response( jQuery.ui.autocomplete.filter(
       							filteredArray, extractLast( request.term ) ) );
       				},
       				focus: function() {
       					// prevent value inserted on focus
       					return false;
       				},
       				select: function( event, ui ) {
						var terms = split( this.value);

       					//var terms = this.value.split(/[\s,]+/);
       					var new_array = [];
       					for( i in terms ){
       						if (terms[i].indexOf(',')>0){
       							temp_array = terms[i].split(',');
       							for (x in temp_array) {
       								new_array.push(temp_array[x]);
       								new_array.push(',');
       							}
       							new_array.pop();
       						} else {
       							new_array.push(terms[i]);
       						}
       						
       					}
       					terms = new_array;
       					// remove the current input
       					terms.pop();
       					// add the selected item
       					terms.push( ui.item.value );
       					// add placeholder to get the comma-and-space at the end
       					terms.push( "" );
       					this.value = terms.join( " " );
       					return false;
       				}
       			
        		});
    		}

        	
       		try {
       		
       	        /*  Text is content passed to the template through the webpy renderer
       			    Parse text, and initialize dataTables for the data */
	       	    json_array = $:text;
	       	    if (json_array!=0) {
					jQuery('#load').hide();
					var error_bool =false;
		     		jQuery('#results').hide();
					jQuery('#results').html('');
					var result_data = jQuery('input[name=results]').val();
					var pathname = jQuery('#filepath').val();
		      		jQuery('#results').append('<br /><table cellpadding="0" cellspacing="0" border="0" class="datatables" id="votable"></table>' ).fadeIn(1500);                            	
		    		
		      		if (json_array!=null && pathname!=null && pathname!="") {	 
	    				var col = [];
			            for (i=0;i<json_array.length;i++) {
	              			col.push({"sTitle":  json_array[i], "mDataProp" : json_array[i]});
	              			
			            }

		        		var tags = json_array;
		        		var availableTags = json_array;
		        		
		        		init_autocomplete("#x_axis");
		        		init_autocomplete("#y_axis");

			            
			            // Initialize dataTable object
			            oTable = jQuery('#votable').dataTable( {
			            	"bJQueryUI" : true,
			        		"sPaginationType": "full_numbers",
			        		"sDom" : 'T<"clear">R<"H"Clfr>t<"F"ip>',
			        		"bProcessing" : true,
			        		"bServerSide" : true,
			        		"aoColumns" : col,					                        		
			        		"bAutoWidth": false,
			        		"oColVis": {
                    			"bRestore": true,
                    			"sSize": "css"
                    		},
			        		"sScrollX": "100%",
			        		"aaSorting": [],
			        		"sSwfPath" : survey_prefix + "/static/static_vo_tool/media/swf/copy_cvs_xls.swf",
			        		"oTableTools": {
                    			"aButtons": [
                    			      "copy_to_votable","copy_to_fits","copy_to_html", "csv_button", "copy"
                    			 ]
                    		},
							"sAjaxSource" :	'data_tables_processing',
							"fnServerData" : function ( sSource, aaData, fnCallback ) {
											  aaData.push({'name' : 'pathname', 'value' : pathname});
											  var is_math_expr = jQuery('#is_math_expr').val();
											  if (is_math_expr=='True'){
												  var axis_names = jQuery("#container div.highcharts-container svg text.highcharts-title tspan").text();
												  if (axis_names!=null && axis_names!=""){
													  axis_names = axis_names.split('  ');
													  var x_expr = axis_names[0];
													  var y_expr = axis_names[2];
													  aaData.push({'name' : 'x_expr', 'value' : x_expr});
													  aaData.push({'name' : 'y_expr', 'value' : y_expr});
												  }
											  }
											  jQuery.ajax({
								           		 "dataType": 'json',
								                 "type": "POST",
								                 "url": sSource,
								                 "data": aaData, 
							                     timeout: 1000000,
							                     "error": function(){
							 		          		if (!error_bool){ 																					
								                    		error_bool = true;
								                    		jQuery('#load').hide();
								            				jQuery('#results').hide();
						   					        		jQuery('#error').html("There was a server error processing your data");
								        					jQuery('#error').fadeIn('normal');
								        					jQuery('#error').delay(3800).fadeOut('slow');   
								 		          	}		
							 						jQuery('#results').hide();
				   					        		
							 		          	},
								                 "success": function(data){
								                	 	if (data==null){
												          	if (!error_bool){ 
								                		 		error_bool = true;
													          	jQuery('#error').html("Query returned invalid data.. Please try another query");
			   					        						jQuery('#error').fadeIn('normal');
			   					        						jQuery('#error').delay(3800).fadeOut('slow'); 
			   					        					  	jQuery('#load').hide();
			   					        					  	data = {"aaData": [], "iTotalRecords": "0", "iTotalDisplayRecords": "0"}	
													          	fnCallback(data);			
													            jQuery('#results').fadeIn('slow');
		  								             		    jQuery("#results .scroll-wrapper").remove();
											                    jQuery('#results .dataTables_scrollBody').doubleScroll();
												          	}
												        } else {
									                    	error_bool = false;
									                    	jQuery('#load').hide();
												          	fnCallback(data);			
												            jQuery('#results').fadeIn('slow');
	  								             		    jQuery("#results .scroll-wrapper").remove();
										                    jQuery('#results .dataTables_scrollBody').doubleScroll();

									               	}
								                 }
								              }); //end ajax call
											 
							 } //end fnServerData function	            
			
			            } ); //end oTable

		            }
			        oTable.fnAdjustColumnSizing(true);                       
				}
       		} catch (ex){
       			alert ('There was an error processing you request');
       		}
       		
       		
       		
            /** 
             * Axis Form submission, fetch input, validate, and send POST request to server
             * POST request should return a new data table with two columns, based on the axis expression
        	 *
             */
            jQuery('#axis_input_form').each(function() {
              jQuery(this).submit(function(){
  				jQuery('#density_notification').html("").hide();
            	jQuery('#load').hide();
                jQuery('#load').show();
    			if (jQuery('.radio_select')!=null){ jQuery('.radio_select').slideUp().remove(); }
            	jQuery('#container').slideUp('slow');
            	jQuery('#get_cur_area').hide();
			 	jQuery('#point_notification').hide();	 
			 	jQuery('#is_math_expr').val('False');
			 	
            	var x_axis = jQuery.trim(jQuery("input#x_axis").val());
        		var y_axis = jQuery.trim(jQuery("input#y_axis").val());
            	var x_alias = jQuery.trim(jQuery("input#x_alias").val());
        		var y_alias = jQuery.trim(jQuery("input#y_alias").val());
        		var query = jQuery("input#query").val();
        		var tap_endpoint = jQuery("input#tap_endpoint").val();
				var selected_mode = jQuery("#mode_notify").html();
	        	var plot_type = jQuery("#plot_type").val();
	        	var bins = jQuery("#bins").val();
	        	var xBins = jQuery("#xBins").val();
				var pathname = jQuery('#filepath').val();
				var inverted = jQuery('input#inverted_val').is(':checked');
				
				if ((inverted==true) && (plot_type=="Scatter" || plot_type=="Mixed")) {
					
					var temp = x_axis;
					x_axis = y_axis;
					y_axis= temp;
		            var temp2 = x_alias;
		            x_alias = y_alias;
		            y_alias = temp2;
		            	
				}
				
				var contin_test = true;

				jQuery('#viewer_table_div').fadeOut('fast');
        		
				if ((plot_type=="Scatter") || (plot_type=="Mixed")){
		    		if (x_axis =='' || y_axis ==''){
	    	    		jQuery('#load').hide();
	        			jQuery('#error').html("Please enter the X and Y axis");
						jQuery('#error').fadeIn('normal');
						jQuery('#error').delay(3800).fadeOut('slow');
		     			contin_test = false;
		    		} else if (x_alias =='' || y_alias ==''){
	        			jQuery('#load').hide();
	        			jQuery('#error').html("Please enter the X and Y labels");
						jQuery('#error').fadeIn('normal');
						jQuery('#error').delay(3800).fadeOut('slow');
						contin_test = false;	
	        		} else if ((selected_mode=="interactive") && (plot_type=="Scatter")) {
	        			if (!isNumber(xBins)){
	        				jQuery('#load').hide();
		        			jQuery('#error').html("Please enter a valid integer for the number of X-Axis bins");
							jQuery('#error').fadeIn('normal');
							jQuery('#error').delay(3800).fadeOut('slow');
							contin_test = false;	
	        			} else {
	        				if (parseInt(xBins)>200 || parseInt(xBins)<=0 ){
	        					jQuery('#load').hide();
			        			jQuery('#error').html("Please enter a number of X-Axis bins less than 100 and more than 0");
								jQuery('#error').fadeIn('normal');
								jQuery('#error').delay(3800).fadeOut('slow');
								contin_test = false;	
	        				}
	        			}
	        			
	        		} 
		    		
        		} else {
        			if (x_axis ==''){
	    	    		jQuery('#load').hide();
	        			jQuery('#error').html("Please enter the X axis");
						jQuery('#error').fadeIn('normal');
						jQuery('#error').delay(3800).fadeOut('slow');
		     			contin_test = false;
		    		} else if (x_alias =='' ){
	        			jQuery('#load').hide();
	        			jQuery('#error').html("Please enter the X label");
						jQuery('#error').fadeIn('normal');
						jQuery('#error').delay(3800).fadeOut('slow');
						contin_test = false;	
	        		}
        			
        		}
		    	
        		if (contin_test) {	
        		
        			var xhr = jQuery.ajax({
                        type: "POST",
                        url : "viewer",
                        data: {xaxis : x_axis,yaxis : y_axis,query : query, tap_endpoint : tap_endpoint, x_alias : x_alias, y_alias : y_alias, mode : selected_mode, plot_type : plot_type, bins : bins, inverted : inverted},
                        timeout: 1000000,
                        error: function() {
                        	jQuery('#load').hide();	
                        	alert('There was an error processing your request');
                        },
                        success: function(data) {
                			jQuery('#load').hide();  
                			if (data!="<div style=\"color:red;margin-left:50px;font-size:12px\">There was an error processing your request</div>"){	                   
                	     		jQuery('#viewer_table_div').hide();	
                	     		jQuery('#user_table_toggle').html('[+]');
                				jQuery('#viewer_table_div .generated_table_content').html('');
    							jQuery('#viewer_table_div .generated_table_content').append('<table cellpadding="0" cellspacing="0" border="0" class="datatables" id ="viewer_tbl"></table>' ).fadeIn();                          		                            
    							jQuery('#viewer_table_div').fadeIn('slow');
    							
    							try {
	                            	var data_array = []
	                            	data_array = jQuery.parseJSON(data);
	                            } catch (ex) { 
		                     		jQuery('#error').html("Query returned invalid data.. Please try another query");
		        					jQuery('#error').fadeIn('normal');
		        					jQuery('#error').delay(3800).fadeOut('slow');        
		        					result_array = "error";
	                            }

	                            if (data_array!="error" && data_array != [] && data_array!=null){		
						            		       	
	                            		var col2 = [];
		                	            for (i=0;i<data_array[0].length;i++) {
		                          			col2.push({"sTitle":  data_array[0][i]});
		                	            }
		                	         
		                	            var o2Table = jQuery('#viewer_tbl').dataTable( {
		                	        		"bJQueryUI": true,
		                	        		"sPaginationType": "full_numbers",
		                	        		"sScrollX": "100%",
		                	        		"sDom": 'T<"clear">R<"H"Clfr>t<"F"ip>',
		                	        		"bProcessing": true,
		                	        		"sSwfPath" : survey_prefix + "/static/static_vo_tool/media/swf/copy_cvs_xls.swf",
		                	        		"aaSorting": [],
		                	        		"oColVis": {
			                        			"bRestore": true,
			                        			"sSize": "css"
			                        		},
		                	        		"oTableTools": {
		                            			"aButtons": [
		                            			      "csv", "copy"
		                            			 ]
		                            		},
		                	        		"aaData":data_array[1],           
		                	        		"aoColumns": col2,
		                	        
		                	             } );	

										jQuery('.generated_table_content').slideUp('fast');	
		                	            jQuery('#viewer_table_div').fadeIn('slow');	 
		                
		                	            
		                	            if (selected_mode == "interactive"){
		                	            	if (plot_type=="Mixed"){ 	//Mixed Scatter/Density plot selected
		                	            		dataToPlot = data_array[1];
		                	            		dataExtremes = getDataExtremes(data_array[1]);
		                	            		jQuery('#container').fadeIn();
		                	            		xBins_int = parseInt(xBins);
		                	            		
		                	            		if (xBins_int !=null) {
		                	            			numBinsX = xBins_int;
		                	            		}
		                	            		
		                	            		var expr_x = Parser.parse(x_axis);
		                	            		var expr_y = Parser.parse(y_axis);
		                	            		

		                	            		if (expr_x.tokens.length>1 || expr_y.tokens.length>1){
		                	            			jQuery('#is_math_expr').val('True');
		                	            		} else {
		                	            			jQuery('#is_math_expr').val('False');
		                	            		}
		                	            		
		                	    				chart = new Highcharts.Chart({
				                	            		chart: {
				                	    	                renderTo: 'container',
				                	    	                defaultSeriesType: 'scatter',
				                	    	            	backgroundColor:'#FFFFFF',
				                	    	            	borderWidth:3,
				                	    	            	borderColor:'#AFC7C7',
				                	    	              	resetZoomEnabled: true,
				                	    	         		marginRight:20,
				                	    	         		spacingLeft: 40,
				                	    	                events: {
				                	    	                	load: function() { handleLoadEvent(this); },
				                	            				redraw: function() { handleRedrawEvent(this,[x_axis,y_axis], true); },
				                	    	    				selection: function(event) { handleSelectEvent(this,event,[x_axis,y_axis]); }

				                	    	                },
				                	    	                zoomType: 'xy'
				                	    	            },
				                	    	            title: {
				                	            			text: "Interactive Data plotting"
				                	            		},
				                	    	            xAxis: {
				                	    	            	title: {
				                	    	                    text: x_alias
				                	    	                },
				                	    	            	type: 'linear',	
				                	    	            	min: dataExtremes.domain.min-(dataExtremes.domain.max-dataExtremes.domain.min)*0.001,
				                	            			max: dataExtremes.domain.max+(dataExtremes.domain.max-dataExtremes.domain.min)*0.001,
				                	            			labels: {
				                	    	                    formatter: function() {	
				                	    	                    	function getRepString2 (rep) {
				                	    	                    		  var rep_float = rep;
				                	    	                    		  rep = rep+''; // coerce to string
				                	    	                    		  if (Math.abs(rep) < 1000000) {
				                	    	                    		    return rep; // return the same number  
				                	    	                    		  } else if (Math.abs(rep) < 1000000000){
				                	    	                    			  return (rep/1000000).toFixed(rep % 1000000 != 0)+'x10^6';
				                	    	                    		  } else if (Math.abs(rep) < 1000000000000){	  
				                	    	                    			  return (rep/1000000000).toFixed(rep % 1000000000 != 0)+'x10^9';
				                	    	                    		  } else {	  
				                	    	                    			  return rep_float.toExponential(5)+'';
				                	    	                    		  }
				                	    	                    		 
				                	    	                    		}
				                	    	                    	return getRepString2(this.value);
				                	    	                    }
				                	    	                }, 
				                	    	                
				                	    	                events: {
				                	    	                    setExtremes: function(e){
				                	    	                       this.resetZoom.show();
				                	    	                    }
				                	    	                }
																
				                	    	            },
				
				                	    	            yAxis: {	
				                	    	                title: {
				                	    	                    text: y_alias
				                	    	                },
				                	    	            	min: dataExtremes.range.min-(dataExtremes.range.max-dataExtremes.range.min)*0.001,
				                	            			max: dataExtremes.range.max+(dataExtremes.range.max-dataExtremes.range.min)*0.001,
				                	    	                labels: {
				                	    	                	align: 'left',
				                	    	                	x: -50,
				                	    	                    formatter: function() {
				
				                	    	                    	function getRepString (rep) {
				                	    	                    		  var rep_float = rep;
				                	    	                    		  rep = rep+''; // coerce to string
				                	    	                    		  if (Math.abs(rep) < 1000000) {
					                	    	                    		    return rep; // return the same number  
					                	    	                    		  } else if (Math.abs(rep) < 1000000000){
					                	    	                    			  return (rep/1000000).toFixed(rep % 1000000 != 0)+'x10^6';
					                	    	                    		  } else if (Math.abs(rep) < 1000000000000){	  
					                	    	                    			  return (rep/1000000000).toFixed(rep % 1000000000 != 0)+'x10^9';
					                	    	                    		  } else {	  
					                	    	                    			  return rep_float.toExponential(5)+'';

					                	    	                    		  }
				                	    	                    		}
														
				                	    	                    	return getRepString(this.value);
				                	    	                    }
				                	    	                },
				                	    	                events: {
				                	    	                    setExtremes: function(e){
				                	    	                       this.resetZoom.show();
				                	    	                   }
				                	    	               }
				
				                	    	            },
				                	    	            navigator: {
				                	    	            	
				                	    	            	enabled: true,
				                	    	                height: 40,
				                	    	                xAxis: {
				                	    	                	      labels : {
				                	    	                	         formatter: function() {
				                	    	                	            return this.value;
				                	    	                	         }
				                	    	                	      }, 	
				                	    	                	      type : 'linear'
				                	    	                },
				                	    	                maskFill: 'rgba(170, 150, 170, 0.75)',
				                	    	                series: {
				                	    	                	data: data_array[1],
				                	    	                    type: 'scatter',
				                	    	                    color: 'rgba(223, 83, 83, .6)',
				                	    	                    radius: 2,
				                	    	                    lineWidth: 0,
				                	    	                    marker: {
				                	    	                        enabled: true,
				                	    	                        symbol: 'circle',
				                	    	                        radius: 1
				                	    	                    }
				                	    	                }
				                	    	            },
				                       					title: {
				                    						text: x_axis + '  x  ' + y_axis
				                    					},
				                    					subtitle: {
				                    						text: 'Table-Plotter dynamic graph'
				                    					},
				                    					rangeSelector: {
				                	    	            	enabled:false
				                	    				},
				                	    	            plotOptions: {
				                	    	                scatter: {
				                	    	                    marker: {
				                	    	                        radius: 2,
				                	    	                        states: {
				                	    	                            hover: {
				                	    	                                enabled: false,
				                	    	                                lineColor: 'rgb(100,100,100)'
				                	    	                            }
				                	    	                        }
				                	    	                    },
				                	    	                    states: {
				                	    	                        hover: {
				                	    	                            marker: {
				                	    	                                enabled: false
				                	    	                            }
				                	    	                        }
				                	    	                    }
				                	    	                }
				                	    	            },
				                	    	            
				                	    	            scrollbar: {
				                	    	            	enabled : true,
				                	    	                barBackgroundColor: 'gray',
				                	    	                barBorderRadius: 7,
				                	    	                barBorderWidth: 0,
				                	    	                buttonBackgroundColor: 'gray',
				                	    	                buttonBorderWidth: 1,
				                	    	                buttonBorderRadius: 7,
				                	    	                trackBackgroundColor: 'none',
				                	    	                trackBorderWidth: 1,
				                	    	                trackBorderRadius: 8,
				                	    	                trackBorderColor: '#CCC'
				                	    	            },
				                	    	            tooltip: {
				                	    	                enabled: false
				                	    	            },
				                	    	            series : [{ 
				                   	    						name: x_alias + " x " + y_alias,
				                   	    						color: 'rgba(119, 152, 191, .6)',
				                   	    						data: data_array[1]
				                   	    					}]
				                	            });

				                	    
			                	            
				                	        	// Hide the dummy points
				                	        	chart.series[0].hide();
				                	        	
				               	                chart.yAxis[0].resetZoom = chart.xAxis[0].resetZoom = jQuery('<button id="button" style="text-decoration:none;font-family:Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif;font-size:12px;color:black;fill:black;">Reset zoom</button>')
				                	                    .appendTo(chart.container)
				                	                    .css({
				                	                        position: 'absolute',
				                	                        top: 70,
				                	                        right: 70,
				                	                        display: 'none'
				                	                    })
				                	                    .click(function(){
				                	                    	chart.xAxis[0].setExtremes(null,null,true,false);
				                	          	         	chart.yAxis[0].setExtremes(null, null,true,false);
				                	                        this.style.display = 'none';
				                	                    });
				               	                
				               	              
					               	            jQuery('#get_cur_area').fadeIn();
		                	            	
		                	            	} else if (plot_type=="Histogram"){   // Histogram option was selected
          		
		                	            		var chart2;
		                	                    chart2 = new Highcharts.Chart({
		                	                        chart: {
		                	                            renderTo: 'container',
		                	                            defaultSeriesType: 'column',
		                	                        	marginLeft:90,
			                	    	         		marginRight:60,
		                	                            backgroundColor:'#FFFFFF',
			                	    	            	borderWidth:3,
			                	    	            	resetZoomEnabled: true,
			                	    	            	borderColor:'#AFC7C7',
			                	    	                zoomType: 'x'
			                	    	            },
		                	                        credits:{
		                	                            enabled:false
		                	                        },
		                	                        xAxis: {
			                	    	            	title: {
			                	    	                    text: x_alias
			                	    	                }
		                	                        },
		                	                        yAxis: {
			                	    	            	title: {
			                	    	                    text: "Frequency"
			                	    	                }
		                	                        },
		                	                        plotOptions: {
		                	                        	series: {
		                	                        		  borderWidth:.5,
		                	                                  pointPadding:0,
		                	                                  groupPadding:0,
		                	                        	}
		                	                        },        
		                	                        xAxis: {
		                	                            categories: data_array[2][0],
		                	                           	lineColor:'#999',
		                	                            tickLength:30,
		                	                            tickColor:'#ccc',
		                	                            labels:{
		                	                                style: {
		                	                                    fontSize:'8px',
		                	                                    fontWeight:'normal',
		                	                                    color:'#333'
		                	                                },
		                	                            }
		                	                        },
		                	                        tooltip:{
		                	                            borderWidth:1,
		                	                            formatter:function() {
		                	                                return '<b>Range:</b><br/> '+ this.x +'<br/>'+
		                	                                '<b>Count:</b> '+ this.y;
		                	                            }
		                	                        },
			                	    	    
		                	                        title: {
		                	                            text: 'Table-Plotter Interactive Histogram Plot',
		                	                        },
		                	                        legend: {
		                	                            enabled:false
		                	                        },
		                	                        series: [{
		                	                        	name: "Frequency",
		                	                        	data: data_array[2][1]
		                	                        }]
		                	                    }); 	

		                	            	
		                	            	} else if (plot_type=="Scatter") {  //Scatter plot was selected
		                	            		
		                	            		dataToPlot = data_array[1];
		                	            		dataExtremes = getDataExtremes(data_array[1]);
		                	            		jQuery('#container').fadeIn();
		                	            		
		                	            		var expr_x = Parser.parse(x_axis);
		                	            		var expr_y = Parser.parse(y_axis);
		                	            		if (expr_x.variables().length>1 || expr_y.variables().length>1){
		                	            			jQuery('#is_math_expr').val('True');
		                	            		} else {
		                	            			jQuery('#is_math_expr').val('False');
		                	            		}
		                	            		
		                	    				chart = new Highcharts.Chart({
				                	            		chart: {
				                	            	
				                	    	                renderTo: 'container',
				                	    	                defaultSeriesType: 'scatter',
				                	    	            	backgroundColor:'#FFFFFF',
				                	    	            	borderWidth:3,
				                	    	            	borderColor:'#AFC7C7',
				                	    	              	resetZoomEnabled: true,
				                	    	         		marginRight:20,
				                	    	         		spacingLeft: 40,
				                	    	                events: {
				                	    	                	load: function() { handleLoadEvent(this); },
				                	            				redraw: function() { handleRedrawEvent(this,[x_axis,y_axis], false); },
				                	    	    				selection: function(event) { handleSelectEvent(this,event,[x_axis,y_axis]); }

				                	    	                },
				                	    	                zoomType: 'xy'
				                	    	            },
				                	    	            title: {
				                	            			text: "Interactive Data plotting"
				                	            		},
				                	    	            xAxis: {
				                	    	            	title: {
				                	    	                    text: x_alias
				                	    	                },
				                	    	            	type: 'linear',	
				                	    	            	min: dataExtremes.domain.min-(dataExtremes.domain.max-dataExtremes.domain.min)*0.001,
				                	            			max: dataExtremes.domain.max+(dataExtremes.domain.max-dataExtremes.domain.min)*0.001,
				                	            			labels: {
				                	    	                    formatter: function() {	
				                	    	                    	function getRepString2 (rep) {
				                	    	                    		  var rep_float = rep;
				                	    	                    		  rep = rep+''; // coerce to string
				                	    	                    		  if (Math.abs(rep) < 1000000) {
				                	    	                    		    return rep; // return the same number  
				                	    	                    		  } else if (Math.abs(rep) < 1000000000){
				                	    	                    			  return (rep/1000000).toFixed(rep % 1000000 != 0)+'x10^6';
				                	    	                    		  } else if (Math.abs(rep) < 1000000000000){	  
				                	    	                    			  return (rep/1000000000).toFixed(rep % 1000000000 != 0)+'x10^9';
				                	    	                    		  } else {	  
				                	    	                    			  return rep_float.toExponential(5)+'';
				                	    	                    		  }
				                	    	                    		 
				                	    	                    		}
				                	    	                    	return getRepString2(this.value);
				                	    	                    }
				                	    	                }, 
				                	    	                
				                	    	                events: {
				                	    	                    setExtremes: function(e){
				                	    	                       this.resetZoom.show();
				                	    	                    }
				                	    	                }
																
				                	    	            },
				
				                	    	            yAxis: {	
				                	    	                title: {
				                	    	                    text: y_alias
				                	    	                },
				                	    	            	min: dataExtremes.range.min-(dataExtremes.range.max-dataExtremes.range.min)*0.001,
				                	            			max: dataExtremes.range.max+(dataExtremes.range.max-dataExtremes.range.min)*0.001,
				                	    	                labels: {
				                	    	                	align: 'left',
				                	    	                	x: -50,
				                	    	                    formatter: function() {
				

				                	    	                    	function getRepString (rep) {
				                	    	                    		  var rep_float = rep;
				                	    	                    		  rep = rep+''; // coerce to string
				                	    	                    		  if (Math.abs(rep) < 1000000) {
					                	    	                    		    return rep; // return the same number  
					                	    	                    		  } else if (Math.abs(rep) < 1000000000){
					                	    	                    			  return (rep/1000000).toFixed(rep % 1000000 != 0)+'x10^6';
					                	    	                    		  } else if (Math.abs(rep) < 1000000000000){	  
					                	    	                    			  return (rep/1000000000).toFixed(rep % 1000000000 != 0)+'x10^9';
					                	    	                    		  } else {	  
					                	    	                    			  return rep_float.toExponential(5)+'';

					                	    	                    		  }
				                	    	                    		}
														
				                	    	                    	return getRepString(this.value);
				                	    	                    }
				                	    	                },
				                	    	                events: {
				                	    	                    setExtremes: function(e){
				                	    	                       this.resetZoom.show();
				                	    	                   }
				                	    	               }
				
				                	    	            },
				                	    	            navigator: {
				                	    	            	
				                	    	            	enabled: true,
				                	    	                height: 40,
				                	    	                xAxis: {
				                	    	                	      labels : {
				                	    	                	         formatter: function() {
				                	    	                	            return this.value;
				                	    	                	         }
				                	    	                	      }, 	
				                	    	                	      type : 'linear'
				                	    	                },
				                	    	                maskFill: 'rgba(170, 150, 170, 0.75)',
				                	    	                series: {
				                	    	                	data: data_array[1],
				                	    	                    type: 'scatter',
				                	    	                    color: 'rgba(223, 83, 83, .6)',
				                	    	                    radius: 2,
				                	    	                    lineWidth: 0,
				                	    	                    marker: {
				                	    	                        enabled: true,
				                	    	                        symbol: 'circle',
				                	    	                        radius: 1
				                	    	                    }
				                	    	                }
				                	    	            },
				                       					title: {
				                    						text: x_axis + '  x  ' + y_axis
				                    					},
				                    					subtitle: {
				                    						text: 'Table-Plotter dynamic graph'
				                    					},
				                    					rangeSelector: {
				                	    	            	enabled:false
				                	    				},
				                	    	            plotOptions: {
				                	    	                scatter: {
				                	    	                    marker: {
				                	    	                        radius: 2,
				                	    	                        states: {
				                	    	                            hover: {
				                	    	                                enabled: false,
				                	    	                                lineColor: 'rgb(100,100,100)'
				                	    	                            }
				                	    	                        }
				                	    	                    },
				                	    	                    states: {
				                	    	                        hover: {
				                	    	                            marker: {
				                	    	                                enabled: false
				                	    	                            }
				                	    	                        }
				                	    	                    }
				                	    	                }
				                	    	            },
				                	    	            
				                	    	            scrollbar: {
				                	    	            	enabled : true,
				                	    	                barBackgroundColor: 'gray',
				                	    	                barBorderRadius: 7,
				                	    	                barBorderWidth: 0,
				                	    	                buttonBackgroundColor: 'gray',
				                	    	                buttonBorderWidth: 1,
				                	    	                buttonBorderRadius: 7,
				                	    	                trackBackgroundColor: 'none',
				                	    	                trackBorderWidth: 1,
				                	    	                trackBorderRadius: 8,
				                	    	                trackBorderColor: '#CCC'
				                	    	            },
				                	    	            tooltip: {
				                	    	                enabled: false
				                	    	            },
				                	    	            series : [{ 
				                   	    						name: x_alias + " x " + y_alias,
				                   	    						color: 'rgba(119, 152, 191, .6)',
				                   	    						data: data_array[1],
				                   	    					   	dataGrouping: {
				                   	    	    	                  groupPixelWidth: 20
				                   	    	    	           }  
				                   	    					}]
				                	            });

				                	    
			                	            
				                	        	// Hide the dummy points
				                	        	chart.series[0].hide();
				                	        	
				               	                chart.yAxis[0].resetZoom = chart.xAxis[0].resetZoom = jQuery('<button id="button" style="text-decoration:none;font-family:Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif;font-size:12px;color:black;fill:black;">Reset zoom</button>')
				                	                    .appendTo(chart.container)
				                	                    .css({
				                	                        position: 'absolute',
				                	                        top: 70,
				                	                        right: 70,
				                	                        display: 'none'
				                	                    })
				                	                    .click(function(){
				                	                    	chart.xAxis[0].setExtremes(null,null,true,false);
				                	          	         	chart.yAxis[0].setExtremes(null, null,true,false);
				                	                        this.style.display = 'none';
				                	                    });
				               	                
				               	              
					               	            jQuery('#get_cur_area').fadeIn();
					               	    
		                	            	
		                	            	}
			
		                	            } else {
		                	            	if (data_array.length>2){
		                	 					var div_content = '<div style="border: 2px solid #AFC7C7;margin:0 auto; text-align:center;margin-bottom:20px;overflow:auto;max-height:800px;padding-top:10px;clear:both;padding-bottom:10px;">' + data_array[2][0] + '</div>';
		                	            		jQuery('#container').html(div_content).hide().fadeIn('slow');		                	            
		                	            	   }
	                         		    	}               
	                            		}
	                            
	                            if (selected_mode == "interactive"){
                	            	if (plot_type=="Mixed" || plot_type=="Scatter" ){
                	            		if (jQuery('.radio_select').length<=0){
                	            			var selection_div = '<div class="radio_select">';
				               	         	selection_div += '<b>Click + Drag action:</b> &nbsp;&nbsp;<input type="radio" id="radSelectZoom" name="radSelectZoom" value="select" />&nbsp;<label for="radSelect">Select</label>&nbsp;&nbsp;<input type="radio" id="radSelectZoom" name="radSelectZoom" value="zoom" checked="checked" />&nbsp;<label for="radZoom">Zoom</label>';
				                            selection_div +='<input type="submit" value="Reset Selection" /></div>';
				               	         	jQuery('#container').after(selection_div);
	                	            	}
                	            	}
                	            }
	                            	jQuery('#container').slideDown('slow');
		               						
	                            
                			} else {
                				jQuery('#error').html("There was an error processing your request. Please check your input for valid expressions (Label names must contain characters and numbers only)");
	        					jQuery('#error').fadeIn('normal');
	        					jQuery('#error').delay(3800).fadeOut('slow');                				
                			}
                        }
                    });

        		} 
        		return false;
        	
       		 });
    	
           });
            
            /** 
             * Toggle user table 
             *
             */
            jQuery('#user_table_toggle').click(function() {
        		  toggle_minimize_button('#user_table_toggle','.generated_table_content','[+]', '[-]');
        		  
            });
        	
            /** 
             * Function for generating SQL for curent area click 
        	 *
        	 */
            jQuery('#get_cur_area_link').click(function() {
        		  jQuery('#get_cur_area_content').html('');
				  var query = jQuery("input#query").val();
				  var axis_names = jQuery("#container div.highcharts-container svg text.highcharts-title tspan").text();
				  axis_names = axis_names.split('  ');
				  var x_axis = axis_names[0];
				  var y_axis = axis_names[2];
				  var x_upper_prev = (jQuery("#container div.highcharts-container svg g.highcharts-axis").first().children('text').last().prev().text());
				  var x_lower_prev = flatten_floatStr(jQuery("#container div.highcharts-container svg g.highcharts-axis").first().children('text').first().next().text());
				  var x_upper = flatten_floatStr(jQuery("#container div.highcharts-container svg g.highcharts-axis").first().children('text').last().text());
				  var x_lower = flatten_floatStr(jQuery("#container div.highcharts-container svg g.highcharts-axis").first().children('text').first().text());
				  //calculate interval to fix axis points
				  x_upper = (parseFloat(x_upper) + (parseFloat(x_upper) - parseFloat(x_upper_prev))).toString();
				  x_lower = (parseFloat(x_lower) + (parseFloat(x_lower) - parseFloat(x_lower_prev))).toString();
				  var y_upper = flatten_floatStr(jQuery("#container div.highcharts-container svg g.highcharts-axis").first().next().next().children('text').last().text());
				  var y_lower = flatten_floatStr(jQuery("#container div.highcharts-container svg g.highcharts-axis").first().next().next().children('text').first().text());

        		  jQuery('#get_cur_area_content').html('<span style="font-style:italic;font-size:11px">Add the following to your original query to get the data points in the current window: <textarea rows="4" cols="80">where ' + x_axis + " between " + x_lower + " and " + x_upper + " and " + y_axis + " between " + y_lower + " and " + y_upper + "</textarea>");
    			  toggle_minimize_button('#get_cur_area_link','#get_cur_area_content','[+]', '[-]');
        		   
        	});
        	
        	/** 
        	 * On Table row click, highligh according points or bins on scatter plot, if scatter plot has been generated 
        	 *
        	 */
        	jQuery("#votable tbody").click(function(event) {
        		
        		try {
	        		jQuery(oTable.fnSettings().aoData).each(function (){
	        			jQuery(this.nTr).removeClass('row_selected');
	        		});
	        		jQuery(event.target.parentNode).addClass('row_selected');
	        	
	        		var nTr = jQuery(event.target.parentNode).closest("tr").get(0);
	        		var rowIndex = oTable.fnGetPosition( nTr);
	        		var aData = oTable.fnGetData( rowIndex )
	        		var pathname = jQuery(pathname_divId).val();  
	        		var params = [];
	        		var sort_col = "";
	        		var sData = oTable.fnSettings();
	        		var params2 = oTable.oApi._fnAjaxParameters(sData);
	        		var sortOrder = "asc";
	        		if (oTable.dataTableSettings[0].aaSorting.length>0){
	            		if (oTable.dataTableSettings[0].aaSorting[0].length>0){
		        			sortOrder = oTable.dataTableSettings[0].aaSorting[0][1];
	            		}
	        		}
	    			
	        		for (var i = 0; i<params2.length;i++){
	        			if (params2[i].name == 'iSortCol_0'){
	        				_get_sort_col = params2[i].value;
	        				params.push({'name' : '_get_sort_col', 'value' : _get_sort_col});
	        				params.push({'name' : '_sSortDir_0', 'value' : sortOrder}); 
	                		break;
	        			}  else if (params2[i].name == 'sSearch'){
	        				params.push({'name' : '_sSearch', 'value' : params2[i].value}); 
	        				
	        			} else if (params2[i].name.indexOf("mDataProp_") == 0){
	        				params.push({'name' : params2[i].name, 'value' : params2[i].value}); 
	        				
	        			}
	        		}
	        		
	        	 	params.push({'name' : '_broadcast_url', 'value' : _broadcast_url});
					params.push({'name' : 'getRowIndexes', 'value' : 'true'}); 
	        	 	params.push({'name' : 'pathname', 'value' : pathname});
	    			
	        	 	var counter = 0;
	        	
	        		if (sData.sAjaxSource=="" || sData.sAjaxSource==null){
	        			
						for (i in aData){
						

							params.push({'name' : "col_" + sData.aoColumns[counter].sTitle, 'value' : aData[counter]});
							counter++;
						}
						
					} else {
						for (i in aData){
							
							params.push({'name' : "col_" + i, 'value' : aData[i]});
						}
						
					}
					
	        	 
	        		if (_broadcast_url!="" && _broadcast_url!=null){
		        	 	var xhr = jQuery.ajax({
		        	       type : "POST",
		        	       data : params,
		        	       url : base_url + '/data_tables_processing',
		        	       timeout: 1000000,
		        	       error: function() {
		        	       	alert('There was an error processing your request');
		        	       },
		        	       success: function(data) {
		        	     	  var index_val = data;
		        	     	  SAMPRowClickHandler(index_val);
		        	       }
		        	 	}); 
	        		}
	        		
	        		
	        		if (jQuery("#container").children().length>0){
		        		// if oTable exists..
						var axis_names = jQuery("#container div.highcharts-container svg text.highcharts-title tspan").text();
						if (axis_names.trim()!="Table-Plotter Interactive Histogram Plot" && jQuery("#mode_notify").html()=="interactive"){
			        		axis_names = axis_names.split('  ');
							var x_axis = axis_names[0];
							var y_axis = axis_names[2];
							var x_axis_index = -1;
							var y_axis_index = -1;
			        		var oSettings = oTable.fnSettings();  
			        		var is_math_expr = jQuery('#is_math_expr').val();
			        		var circle = [];
			        		
			        		
			        		if (is_math_expr=='True'){
			        			var selected_point = fnGetSelectedEval(oTable,x_axis,y_axis,oSettings.aoColumns);
			        			var circles = jQuery('circle');
			        			for (var i=0;i<circles.length;i++){
			        				if (Math.abs(selected_point[0] - circles[i].attributes.dataX.value)<=0.0001 && Math.abs(selected_point[1] - circles[i].attributes.dataY.value)<=0.0001 ){
			        					circle = [circles[i]];
			        					break;
			        				}
			        			}
			        			
			        		} else {
			        	
				        		for (var i =0;i<oSettings.aoColumns.length;i++){
				        			if (oSettings.aoColumns[i].sTitle.toLowerCase() == x_axis.toLowerCase()){
				        				x_axis_index = i;
				        			} 
				        			
				        			if (oSettings.aoColumns[i].sTitle.toLowerCase() === y_axis.toLowerCase()){
				        				y_axis_index = i;
				        			}
				        		}
				        		
				        		var selected_point = fnGetSelected(oTable,x_axis_index,y_axis_index);
				        		//circle = jQuery('circle[dataX="' + selected_point[0] + '"][dataY="' + selected_point[1] +'"]');
				        		circle = jQuery('circle').filter(function() {
	      		        	          
    		        				var dataX = jQuery(this).attr('dataX');
    		        	            var dataY = jQuery(this).attr('dataY');
    		        	          	
    		        	        	return (dataX==  selected_point[0] && dataY== selected_point[1]);
    		        	           
    		        	        });
			        		}
			        		
			     
			        	 	jQuery.each(jQuery('circle'), function(i, val) {
			        	    	 if (jQuery(this)[0].attributes.selected.value == 'True'){
									 jQuery('#point_notification').slideUp('slow');	 
						    		 jQuery(this)[0].attributes.selected.value = 'False';
						    		 jQuery(this)[0].attributes['fill-opacity'].value = '0.6';
								 jQuery(this)[0].attributes['fill'].value ='rgb(119,152,191)';	
								}
			        	    });
	
			        	    jQuery.each(jQuery('rect'), function(i, val) {
			        	    	if (this.attributes.selected!=null){
				        	    	 if (jQuery(this)[0].attributes.selected.value == 'True'){
			        	    			jQuery('#point_notification').slideUp('slow');	 
			        	    			jQuery('#density_notification').html("").slideUp('slow');
							 		 	jQuery(this)[0].attributes.selected.value = 'False';
							 		 	jQuery(this)[0].attributes['stroke'].value = 'gray';
				        	    	 }
			        	    	}		        	   
			        	    });
		        	    
			        	    if (circle!=null){
				        		if (circle[0]!=null){
					        			var selected = jQuery(circle)[0].attributes.selected.value;
									 	if (selected=='True'){
									         jQuery('#point_notification').slideUp('slow');	 
								    		 jQuery(circle)[0].attributes.selected.value = 'False';
								    		 jQuery(circle)[0].attributes['fill-opacity'].value = '0.6';
 										 jQuery(circle)[0].attributes['fill'].value ='rgb(119,152,191)';
									 	 } else {
						      	    		 jQuery('#point_notification').slideDown('slow');
								    		 jQuery(circle)[0].attributes['fill-opacity'].value = '0.95';
										 jQuery(circle)[0].attributes['fill'].value = 'rgb(52,236,46)';
								    		 jQuery(circle)[0].attributes.selected.value = 'True';
									 	 }
				        		} else {
				        			
				        			rect = jQuery('rect').filter(function() {
				        	          
				        				var xMax = jQuery(this).attr('xMax');
				        	            var xMin = jQuery(this).attr('xMin');
				        	            var yMax = jQuery(this).attr('yMax');
				        	            var yMin = jQuery(this).attr('yMin');
				        	        	
				        	            if (xMax!=null && yMax!=null && xMin!=null && yMin!=null){
				        	          	  	return parseFloat(selected_point[0]) >= parseFloat(xMin) && parseFloat(selected_point[0]) <= parseFloat(xMax) && parseFloat(selected_point[1]) <= parseFloat(yMax) && parseFloat(selected_point[1]) >= parseFloat(yMin);
				        	            }
				        	        });
				        			
				        			if (jQuery(rect)[0]!=null){
					        			jQuery(rect)[0].attributes.selected.value ='True';
					        			jQuery(rect)[0].attributes['stroke'].value = 'rgb(119,152,191)';
					      	    		jQuery('#point_notification').slideDown('slow');
				      		            jQuery('#density_notification').html('Density: ' + jQuery(rect)[0].attributes['density'].value).slideDown('slow');
					        		}
				        		}
			        	    }
		        		}
	        		}
        		} catch (err){
        			console.log(err);
        		}
        		
        	});
        	
      
        	
        });

		/* End JS Viewer Functions*/
	      
		</script>

<link rel="icon" type="image/png"
	href="$survey_prefix/static/static_vo_tool/icon2.png">

	<!--[if lt IE 7]>
		<style type="text/css">
   		.dock img { behavior: url(iepngfix.htc) }
   		</style>
	<![endif]>
    
                              
	<!--[if IE]>
        <link rel="stylesheet" type="text/css" href="$survey_prefix/static/static_vo_tool/styleIE.css" />
			<style type="text/css" media="screen">
				#header div{
					background-image: none;
					filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(src='overlay.png', sizingMethod='scale');
				}
			</style>
	<![endif]-->
	<!--[if lte IE 6]>
			<style type="text/css" media="screen">
				#header div{
					background-image: none;
					filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(src='overlay.png', sizingMethod='scale');
				}
			</style>
	<![endif]-->
</head>

<body>


	<div id="menu"
		style="position: absolute; top: 13px; z-index: 10; margin-left: 10px">
		<ul class="menu">
			<li><a href="#"><span>Select Mode</span></a>
				<div id="submenu">
					<ul>
						<li><a href="#" id="interactive"><span>Interactive</span></a></li>
						<li><a href="#" id="static"><span>Static</span></a></li>
					</ul>
				</div></li>
		</ul>

	</div>


	<div id="viewer_header">
		<div
			style="float: left; position: absolute; top: 20px; margin-left: 130px;">
			<a href="#help" rel="facebox"
				style="color: gray; text-decoration: none;">Help</a>
		</div>
		<h3>Table Plotter</h3>
		<div id="mode_notify"
			style="font-size: 12px; color: white; font-style: italic;">interactive</div>
	</div>
	<div id="gradient"></div>


	<div id="axis_input">
		<span style="margin-left: 50px; font-size: 12px;">Please enter
			a X and Y axis for the plot:</span> <br />
		<br />
		<div
			style="width: 580px; height: 138px; display: block; margin-left: 150px">
			<form style="width: 580px;" method="post" id="axis_input_form">

				<div style="width: 580px; height: 30px;">
					<label class="long_label" for="x-axis">X-Axis Expression:</label> <input
						name="x_axis" type="text" id="x_axis" />&nbsp;&nbsp;&nbsp; <span
						style="float: right"><label
						style="width: 94px; display: inline-block; vertical-align: baseline;"
						for="x_alias">X-Axis Label:</label> <input name="x_alias"
						type="text" id="x_alias" /></span>
				</div>

				<div style="width: 580px; height: 30px;">

					<label
						style="width: 124px; display: inline-block; vertical-align: baseline;"
						for="y-axis">Y-Axis Expression:</label><input name="y_axis"
						type="text" id="y_axis" />&nbsp;&nbsp;&nbsp; <span
						style="float: right"><label
						style="width: 94px; display: inline-block; vertical-align: baseline;"
						for="y_alias">Y-Axis Label:</label><input name="y_alias"
						type="text" id="y_alias" /></span>
				</div>

				<input type="hidden" style="display: none" name="query" id="query"
					$:query />
				<input type="hidden" style="display: none" name="filepath"
					id="filepath" $:filepath />
				<input type="hidden" style="display: none" name="tap_endpoint"
					id="tap_endpoint" $:tap_endpoint />
				<input type="hidden" style="display: none" name="results" $:results />
				<input type="hidden" style="display: none" name="is_math_expr"
					id="is_math_expr" value="False" />

				<div style="width: 570px; margin: 10px; height: 30px;">
					<label class="short_label" for="plot_type">Plot type:</label> <select
						name="plot_type" id="plot_type"
						style="margin-top: 5px; margin-left: 10px;">
						<option value="Mixed">Mixed Scatter/Density</option>
						<option value="Scatter">Scatter</option>
						<option value="Histogram">Histogram</option>
					</select>




					<div id="xBins_container"
						style="width: 150px; float: right; display: inline; text-align: right;">
						<label for="xBins"># Bins on X-Axis:</label><input
							style="width: 40px;" name="xBins" type="text" id="xBins"
							value="35" placeholder="35" />
					</div>
					<div id="bins_container"
						style="width: 150px; float: right; display: none; text-align: right;">
						<label class="very_short_label" for="bins">Bins:</label> <select
							name="bins" id="bins" style="margin-top: 5px; margin-left: 10px;">
							<option value="10">10</option>
							<option value="20">20</option>
							<option value="50">50</option>
							<option value="100">100</option>
						</select>
					</div>
					<div id="inverted"
						style="margin-top: 5px; height: 35px; width: 80px; float: right; margin-right: 20px;">
						<input style="height: 15px; width: 15px; vertical-align: -15%;"
							type="checkbox" name="inverted" id="inverted_val"
							value="inverted" /> Inverted
					</div>

				</div>
				<div id="clear" style="clear: both"></div>
				<input type="submit" value="Submit" class="submit" />

			</form>
		</div>

		<span
			style="color: gray; font-style: italic; font-size: 12px; margin-left: 50px; margin-top: 5px;">Help
			with input values</span> <a id="plot_expression_help_link">[+]</a>

	</div>

	<div id="post-it-example">
		<div id="plot_expression_help"
			style="width: 280px; height: 200px; padding-left: 55px; padding-top: 40px">
			<p>Enter an expression for the X & Y axis.</p>
			<small>(Can be any mathematical expression, formed using the
				column names)</small><br>

				<div style="margin-left: 55px;">
					<br> <b>Example:</b><br> X-Axis: yCorMag-xCorMag<br>
								Y-Axis: ra 
				</div>
		</div>
	</div>


	<div id="container"
		style="width: 900px; min-height: 620px; margin: 0 auto; display: none; margin-bottom: 5px"></div>

	<div id="load"></div>

	<div id="density_notification"
		style="display: none; font-size: 11px; color: green; margin: 0 auto; text-align: center; font-weight: bold"></div>

	<div id="point_notification"
		style="display: none; font-size: 12px; color: green; margin: 0 auto; text-align: center; font-style: italic">Un-select
		the points to reset the table data</div>

	<div id="error"></div>



	<div id="viewer_table_div">

		<div style="padding: 10px; margin-top: 20px;">
			<div id="get_cur_area" style="display: none">
				SQL query for filtering to the currently selected area <a
					id="get_cur_area_link">[+]</a>
				<div id="get_cur_area_content" style="display: none"></div>
			</div>
			<br /> Table of user-generated plot points <a id="user_table_toggle"
				style="font-size: 13px; padding-bottom: 52px;">[+]</a>
		</div>

		<div class="generated_table_content"></div>
		<br>
	</div>

	<br>




		<div style="display: none">
			<div id="save_as">
				<form method="post" action="save_as_vot" name="save_as_vot">
					<input type="hidden" name="pathname" $:filepath> <input
						type="submit" value="Save as Votable" class="save_button">
				</form>
			</div>
			<div id="save_as">
				<form method="post" action="save_as_html" name="save_as_html">
					<input type="hidden" name="pathname" $:filepath> <input
						type="submit" value="Save as HTML" class="save_button">
				</form>
			</div>
			<div id="save_as">
				<form method="post" action="save_as_fits" name="save_as_fits">
					<input type="hidden" name="pathname" $:filepath> <input
						type="submit" value="Save as Fits" class="save_button">
				</form>
			</div>
		</div>

		<div
			style="margin-left: 80px; margin-top: 18px; float: left; z-index: 100; position: relative;">
			<img id="samp_connection"
				src="$survey_prefix/static/images/red-button.png" height="17"
				width="17" />
			<button id="register">Connect to SAMP</button>
			<button id="unregister" style="display: none;">Disconnect
				from SAMP</button>
			<button id="loadvotable" style="display: none;">Broadcast
				results table</button>
		</div>

		<div id="results"></div> <br>

			<div id="help" style="display: none; font-size: 13px;">
				<h5>Help:</h5>
				<br><br>
						<p style="font-size: 12px;">
							<b>Interactive mode:</b> An interactive plot will be generated,
							where you can zoom in and out, in a dynamic way.<br> Not
								recommended for very large data sets (e.g. > 1,000,000 cells),
								as the web browser will be slow responding to your requests. <br><br>
										<b>Static mode:</b> A static plot will be generated, which is
										a non-interactive png image. Use if interactive mode is unable
										to handle the amount of data you require to have plotted. <br><br><br><br>
						</p>
			</div>

			<div style="visibility: hidden">
				<br /> <a href="http://apycom.com/">link</a><br />
			</div>
</body>

</html>




